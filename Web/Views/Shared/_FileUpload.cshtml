@*
    Reusable File Upload Component for Cover Images
    
    Parameters:
    - string currentImageUrl: The current image URL (if any)
    - string entityName: Name of the entity (e.g., "categories", "books") for subfolder organization under uploads/
    - string fieldName: Name of the field (default: "coverImageFile")
    - int? entityId: ID of the entity (for edit scenarios)
    - string removeAction: Action name for removing image (default: "RemoveCoverImage")
    
    Note: All files are stored in the uploads/ directory with subfolders for organization.
*@

@{
    var currentImageUrl = ViewData["CurrentImageUrl"] as string;
    var entityName = ViewData["EntityName"] as string ?? "images";
    var fieldName = ViewData["FieldName"] as string ?? "coverImageFile";
    var entityId = ViewData["EntityId"] == null ? (int?)null : Convert.ToInt32(ViewData["EntityId"]);
    var removeAction = ViewData["RemoveAction"] as string ?? "RemoveCoverImage";
    var urlFieldName = ViewData["UrlFieldName"] as string ?? "CoverImageUrl";
}

<!-- Cover Image URL Input -->
<div class="mb-4">
    <label for="@urlFieldName" class="block text-on-surface-strong dark:text-on-surface-dark-strong font-medium mb-1">Cover Image URL</label>
    <input name="@urlFieldName" 
           id="@urlFieldName"
           value="@currentImageUrl"
           class="w-full rounded-radius border border-outline dark:border-outline-dark px-4 py-2 focus:border-primary dark:focus:border-primary-dark focus:outline-none bg-surface dark:bg-surface-dark text-on-surface-strong dark:text-on-surface-dark-strong" />
    <p class="mt-1 text-on-surface dark:text-on-surface-dark text-sm">Enter a URL for the cover image.</p>
</div>

<!-- Current Image Display (for edit mode) -->
@if (!string.IsNullOrEmpty(currentImageUrl) && entityId.HasValue)
{
    <div class="mb-4">
        <label class="block text-on-surface-strong dark:text-on-surface-dark-strong font-medium mb-1">Current Cover Image</label>
        <div class="relative inline-block">
            <img src="@currentImageUrl" alt="Current cover" class="max-w-xs max-h-48 rounded-radius border border-outline dark:border-outline-dark">
            <form asp-action="@removeAction" asp-route-id="@entityId" method="post" class="inline">
                @Html.AntiForgeryToken()
                <button type="submit" class="absolute top-2 right-2 bg-danger text-on-danger rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-danger-dark" title="Remove current image">
                    x
                </button>
            </form>
        </div>
    </div>
}

<!-- File Upload Option -->
<div class="mb-4">
    <label for="@fieldName" class="block text-on-surface-strong dark:text-on-surface-dark-strong font-medium mb-1">
        @(entityId.HasValue ? "Upload New Cover Image" : "Or Upload Cover Image")
    </label>
    <div class="relative">
        <input type="file" 
               name="@fieldName" 
               id="@fieldName" 
               accept="image/*" 
               class="w-full rounded-radius border border-outline dark:border-outline-dark px-4 py-2 focus:border-primary dark:focus:border-primary-dark focus:outline-none bg-surface dark:bg-surface-dark text-on-surface-strong dark:text-on-surface-dark-strong file:mr-4 file:py-2 file:px-4 file:rounded-radius file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-on-primary hover:file:bg-primary-dark" />
    </div>
    <div class="text-danger text-sm">
        @Html.ValidationMessage(fieldName)
    </div>
    <p class="mt-1 text-on-surface dark:text-on-surface-dark text-sm">
        Upload an image file (JPG, PNG, GIF, BMP, WebP). Maximum file size: 5MB.
    </p>
</div>

<!-- Image Preview -->
<div id="imagePreview-@fieldName" class="mb-4 hidden">
    <label class="block text-on-surface-strong dark:text-on-surface-dark-strong font-medium mb-1">
        @(entityId.HasValue ? "New Image Preview" : "Image Preview")
    </label>
    <div class="relative inline-block">
        <img id="previewImg-@fieldName" src="" alt="Preview" class="max-w-xs max-h-48 rounded-radius border border-outline dark:border-outline-dark">
        <button type="button" id="removePreview-@fieldName" class="absolute top-2 right-2 bg-danger text-on-danger rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-danger-dark">
            x
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('@fieldName');
        const urlInput = document.getElementById('@urlFieldName');
        const imagePreview = document.getElementById('imagePreview-@fieldName');
        const previewImg = document.getElementById('previewImg-@fieldName');
        const removePreview = document.getElementById('removePreview-@fieldName');

        if (fileInput && urlInput && imagePreview && previewImg && removePreview) {
            // Handle file selection
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Clear URL input when file is selected
                    urlInput.value = '';
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Handle URL input
            urlInput.addEventListener('input', function(e) {
                if (e.target.value) {
                    // Clear file input when URL is entered
                    fileInput.value = '';
                    imagePreview.classList.add('hidden');
                }
            });

            // Handle preview removal
            removePreview.addEventListener('click', function() {
                fileInput.value = '';
                imagePreview.classList.add('hidden');
            });
        }
    });
</script>
